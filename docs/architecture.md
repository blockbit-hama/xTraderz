# 주문 매칭 엔진 - 최종 프로젝트 구조 (MDP)

아래는 Market Data Publisher(MDP)가 통합된 주문 매칭 엔진의 최종 프로젝트 구조입니다:

```
order-matching-engine/
│
├── Cargo.toml                 # 프로젝트 설정 및 의존성
├── Cargo.lock
├── build.rs                   # 빌드 스크립트
├── README.md                  # 프로젝트 설명 및 사용 방법
│
├── src/                       # 소스 코드
│   ├── lib.rs                 # 라이브러리 루트 모듈 및 재내보내기
│   ├── main.rs                # 애플리케이션 진입점
│   ├── models.rs              # 데이터 모델 정의 (Order, Execution, OrderBook 등)
│   ├── matching_engine.rs     # 주문 매칭 엔진 구현
│   ├── sequencer.rs           # 입력/출력 시퀀서
│   ├── order_manager.rs       # 주문 관리 API
│   │
│   ├── websocket/             # WebSocket 관련 코드 (체결 정보 알림용)
│   │   ├── mod.rs             # WebSocket 모듈 정의
│   │   └── execution_push.rs  # 체결 실시간 알림
│   │
│   ├── market_data_publisher/ # 시장 데이터 발행자 (MDP)
│   │   ├── mod.rs             # MDP 모듈 정의
│   │   ├── publisher.rs       # 주요 MDP 구현 - 오더북, 체결, 통계 관리
│   │   ├── candlestick.rs     # 봉차트 관리자
│   │   └── models.rs          # MDP 관련 데이터 모델
│   │
│   └── util/                  # 유틸리티 함수
│       ├── mod.rs             # 유틸리티 모듈 정의
│       └── serializer.rs      # 데이터 직렬화/역직렬화
│
├── tests/                     # 테스트 코드
│   ├── integration_test.rs    # 통합 테스트
│   ├── websocket_test.rs      # WebSocket 테스트
│   └── mdp_test.rs            # 시장 데이터 발행자 테스트
│
├── examples/                  # 예제 코드
│   ├── simple_client.rs       # 간단한 클라이언트 예제
│   └── order_simulation.rs    # 주문 시뮬레이션 예제
│
└── docs/                      # 문서
    ├── architecture.md        # 아키텍처 문서
    ├── api.md                 # API 명세
    └── market_data_api.md     # 시장 데이터 API 문서
```

## 주요 파일 설명

### 핵심 구조

- **lib.rs**: 라이브러리의 루트 모듈로, 다른 모듈을 외부로 노출하고 주요 구조체를 재내보냅니다.
- **main.rs**: 실행 파일의 진입점으로, 서버 시작 및 컴포넌트 초기화를 담당합니다.
- **models.rs**: 주문, 체결, 주문책 등의 기본 데이터 모델을 정의합니다.
- **matching_engine.rs**: 주문 매칭 알고리즘을 구현합니다.
- **sequencer.rs**: 주문 및 체결 처리 순서를 보장합니다.
- **order_manager.rs**: 주문 관리 REST API 엔드포인트를 제공합니다.

### WebSocket 체결 알림

- **websocket/mod.rs**: WebSocket 모듈의 진입점입니다.
- **websocket/execution_push.rs**: 체결 정보를 실시간으로 클라이언트에 푸시합니다.

### 시장 데이터 발행자 (MDP)

- **market_data_publisher/mod.rs**: MDP 모듈의 진입점입니다.
- **market_data_publisher/publisher.rs**: 오더북 상태, 체결 정보, 시장 통계 데이터를 관리하고 HTTP API를 통해 제공합니다.
- **market_data_publisher/candlestick.rs**: 체결 정보를 기반으로 다양한 시간 간격의 봉차트 데이터를 생성하고 관리합니다.
- **market_data_publisher/models.rs**: 시장 데이터 관련 모델 및 원형 버퍼 구현을 포함합니다.

### 유틸리티 및 기타

- **util/serializer.rs**: 데이터 직렬화 및 역직렬화 유틸리티를 제공합니다.
- **build.rs**: 빌드 타임 작업을 수행하는 스크립트입니다.
- **Cargo.toml**: 프로젝트 메타데이터 및 의존성을 정의합니다.

## 모듈 의존 관계

```
                         +---------------+
                         |     main      |
                         +---------------+
                                |
                 +-------------------------------+
                 |              |                |
        +----------------+      |        +----------------+
        |  order_manager |      |        |    websocket   |
        +----------------+      |        +----------------+
                |               |                |
                |        +-------------+         |
                +------->|  sequencer  |<--------+
                         +-------------+
                                |
                         +-------------+
                         |  matching   |
                         |   engine    |
                         +-------------+
                                |
                         +-------------+
                         |   models    |<---------------------+
                         +-------------+                      |
                                |                             |
                         +------------------+          +------------------+
                         | market_data_pub. |--------->|       util      |
                         +------------------+          +------------------+
```

## 주요 데이터 흐름

### 1. 주문 처리 흐름 (주요 파이프라인)

1. 클라이언트가 REST API를 통해 주문 제출
2. 주문 관리자(order_manager)가 주문을 입력 시퀀서로 전달
3. 시퀀서(sequencer)가 주문을 매칭 엔진으로 순서대로 전달
4. 매칭 엔진(matching_engine)이 주문 매칭 처리 및 체결 생성
5. 시퀀서를 통해 체결 정보가 분배:
   - WebSocket을 통해 실시간 체결 알림 푸시
   - 시장 데이터 발행자(MDP)로 전달

### 2. 시장 데이터 흐름 (MDP)

1. MDP가 매칭 엔진으로부터 오더북 상태 및 체결 정보 수신
2. 수신한 데이터를 기반으로 다양한 데이터 생성 및 관리:
   - 오더북 스냅샷: 현재 호가창 상태
   - 체결 이력: 최근 체결 내역
   - 시장 통계: 24시간 가격 변화, 거래량 등
   - 봉차트 데이터: 다양한 시간 간격(1분, 5분, 1시간 등)의 OHLCV 데이터
3. HTTP API를 통해 클라이언트에게 시장 데이터 제공

## 주요 API 엔드포인트

### 주문 관리 API

- `POST /v1/order`: 새 주문 생성
- `POST /v1/order/cancel`: 주문 취소
- `GET /v1/execution`: 체결 내역 조회

### 시장 데이터 API

- `GET /api/v1/orderbook/{symbol}`: 특정 심볼의 오더북 조회
- `GET /api/v1/executions/{symbol}`: 최근 체결 내역 조회
- `GET /api/v1/statistics/{symbol}`: 24시간 시장 통계 조회
- `GET /api/v1/klines/{symbol}/{interval}`: 봉차트 데이터 조회 (interval: 1m, 5m, 15m, 1h, 1d 등)

### WebSocket 엔드포인트

- `ws://127.0.0.1:3030/ws/executions`: 실시간 체결 정보 수신

## MDP 특징

### 1. 오더북 데이터 관리

- 매칭 엔진으로부터 오더북 상태 업데이트 수신
- 각 심볼별로 최신 오더북 상태 유지
- HTTP API를 통한 오더북 스냅샷 제공

### 2. 체결 데이터 관리

- 최근 체결 내역 저장 (심볼당 최대 1000개)
- 체결 정보를 바탕으로 다양한 통계 계산
- HTTP API를 통한 체결 내역 조회

### 3. 시장 통계 계산

- 24시간 가격 변화, 최고가, 최저가, 거래량 관리
- 현재 최고 매수가, 최저 매도가 추적
- 가격 변화율 계산 및 제공

### 4. 봉차트 데이터 관리

- 원형 버퍼를 사용한 효율적인 봉차트 데이터 저장
- 다양한 시간 간격 지원: 1분, 5분, 15분, 30분, 1시간, 4시간, 1일, 1주일
- 시간 간격별 적절한 데이터 보존 기간 설정
- 실시간 봉차트 업데이트 및 완료된 봉차트 저장

### 5. HTTP API

- RESTful API를 통한 시장 데이터 제공
- 데이터 필터링 및 제한 기능 (개수 제한 등)
- 존재하지 않는 심볼에 대한 적절한 응답 처리

### 6. 확장성 고려

- 동시성 안전한 데이터 구조 사용 (Arc, Mutex)
- 제한된 메모리 사용을 위한 데이터 크기 제한
- 다양한 심볼 및 시간 간격 지원

## 원형 버퍼(Circular Buffer)

MDP의 핵심 기능 중 하나는 시계열 데이터의 효율적인 관리입니다. 특히 봉차트 데이터와 같이 시간에 따라 계속 생성되는 데이터를 관리하기 위해 원형 버퍼를 사용합니다.

원형 버퍼의 특징:

1. **고정 크기 메모리 사용**: 데이터가 계속 들어와도 메모리 사용량은 일정하게 유지
2. **FIFO(First-In-First-Out) 방식**: 가장 오래된 데이터가 새 데이터에 의해 대체됨
3. **시간 간격별 최적화**: 각 시간 간격에 적합한 버퍼 크기 설정 가능

시간 간격별 버퍼 크기:
- 1분봉: 1440개 (24시간)
- 5분봉: 1152개 (4일)
- 15분봉: 960개 (10일)
- 30분봉: 1008개 (3주)
- 1시간봉: 720개 (30일)
- 4시간봉: 720개 (120일)
- 일봉: 365개 (1년)
- 주봉: 156개 (3년)

이러한 설계를 통해 MDP는 과거 데이터를 효율적으로 관리하면서도 현재 시장 상태를 정확히 반영할 수 있습니다.
