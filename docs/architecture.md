# 주문 매칭 엔진 아키텍처

이 문서는 주문 매칭 엔진의 아키텍처와 핵심 컴포넌트에 대해 설명합니다.

## 시스템 개요

주문 매칭 엔진은 금융 거래소의 핵심 부분으로, 매수자와 매도자 간의 주문을 매칭시켜 거래를 체결하는 역할을 담당합니다. 이 시스템은 고성능, 확장성, 신뢰성을 갖추도록 설계되었으며, 두 개의 독립적인 파이프라인으로 구성됩니다:

1. **주문 처리 파이프라인**: 주문 접수부터 체결까지의 핵심 거래 흐름
2. **UI 업데이트 파이프라인**: 고객의 호가창 UI에 실시간 오더북 상태를 전달하는 별도 흐름

```
[주문 처리 파이프라인]
[클라이언트] <---> [주문 관리자] --> [입력 시퀀서] --> [매칭 엔진] --> [출력 시퀀서] --> [HTTP 응답]
                                                         |
                                                         v
[UI 업데이트 파이프라인]                              [오더북 상태]
[클라이언트 UI] <--- [WebSocket] <--- [릴레이 서버] <------'
    호가창                                 |
                                           v
[클라이언트 UI] <--- [WebSocket] <--- [체결 정보 푸시]
   체결 알림
```

두 파이프라인은 독립적으로 작동하여 성능 저하나 장애 전파를 방지합니다.

## 핵심 컴포넌트

### 1. 데이터 모델 (models.rs)

시스템의 핵심 데이터 구조를 정의합니다:

- **Order**: 주문 정보 (ID, 심볼, 가격, 수량, 매수/매도 등)
- **Execution**: 체결 정보 (실행 ID, 주문 ID, 가격, 수량 등)
- **OrderBook**: 주문책 구조로, 매수와 매도 주문을 저장
- **Book**: 한쪽 방향(매수 또는 매도)의 주문책
- **PriceLevel**: 특정 가격 수준의 주문 목록

주문책은 가격-시간 우선순위를 사용하여 주문을 매칭합니다:
- 매수 주문은 가격 내림차순으로 정렬 (높은 가격 우선)
- 매도 주문은 가격 오름차순으로 정렬 (낮은 가격 우선)
- 동일 가격 수준에서는 먼저 들어온 주문이 우선 처리 (FIFO)

### 2. 주문 관리자 (order_manager.rs)

외부 시스템과의 인터페이스를 담당합니다:

- **REST API 엔드포인트** 제공: 주문 생성, 취소, 조회
- **주문 유효성 검사** 수행: 필수 필드 확인, 형식 검증
- 유효한 주문을 **시퀀서**로 전달

### 3. 시퀀서 (sequencer.rs)

주문과 체결의 순서를 관리합니다:

- **입력 시퀀서**: 들어오는 주문을 순서대로 처리
- **출력 시퀀서**: 체결 결과를 순서대로 배포
- 시스템 신뢰성과 일관성 보장

### 4. 매칭 엔진 (matching_engine.rs)

주문 매칭 알고리즘의 핵심 구현:

- 주문책(OrderBook) 관리
- 새 주문에 대한 매칭 로직 실행
- 체결 생성 및 배포
- 부분 체결 처리

매칭 과정:
1. 새 주문이 들어오면 반대쪽 주문책에서 매칭 가능한 주문 탐색
2. 가격-시간 우선순위에 따라 매칭
3. 체결 결과 생성
4. 완전히 체결되지 않은 남은 주문은 주문책에 삽입

### 5. WebSocket 서비스 (websocket/*.rs)

실시간 데이터 스트림을 클라이언트에 제공:

- **execution_push**: 체결 정보 실시간 푸시
- **orderbook_relay**: 오더북 상태 변화 실시간 전송

### 6. 릴레이 서버 (relay/*.rs)

오더북 상태를 클라이언트 UI에 중계:

- **server**: 오더북 상태 관리 및 구독 처리
- **client_handler**: 클라이언트 연결 및 메시지 처리

릴레이 서버는 주문 처리 파이프라인과 **완전히 독립적**으로 작동합니다. 이는 UI 업데이트로 인한 과부하가 핵심 거래 기능에 영향을 주지 않도록 하기 위함입니다.

### 7. 유틸리티 (util/*.rs)

공통 기능을 제공하는 헬퍼 모듈:

- **serializer**: 데이터 직렬화/역직렬화 유틸리티

## 데이터 흐름

### 주문 처리 파이프라인

1. **주문 접수**:
   - 클라이언트가 REST API를 통해 주문 제출
   - 주문 관리자가 유효성 검사 후 시퀀서로 전달

2. **주문 처리**:
   - 시퀀서가 주문을 순서대로 처리
   - 매칭 엔진이 주문책에서 매칭 시도
   - 체결이 발생하면 체결 정보 생성

3. **결과 전달**:
   - 출력 시퀀서가 체결 정보를 정렬
   - HTTP 응답으로 클라이언트에 결과 반환

### UI 업데이트 파이프라인

1. **오더북 상태 모니터링**:
   - 매칭 엔진이 오더북 상태를 업데이트
   - 릴레이 서버가 오더북 상태 변화 감지

2. **실시간 데이터 중계**:
   - 릴레이 서버가 구독 중인 심볼의 오더북 업데이트 전송
   - WebSocket을 통해 클라이언트 UI에 실시간 데이터 전달

3. **체결 알림**:
   - 체결 발생 시 WebSocket을 통해 관련 클라이언트에 즉시 알림

## 독립적인 파이프라인의 이점

두 파이프라인을 분리함으로써 다음과 같은 이점을 얻을 수 있습니다:

1. **성능 격리**: UI 업데이트 과부하가 주문 처리에 영향을 주지 않음
2. **확장성**: 각 파이프라인을 독립적으로 확장 가능
3. **장애 격리**: 한 파이프라인의 장애가 다른 파이프라인에 전파되지 않음
4. **리소스 우선순위**: 주문 처리에 더 많은 리소스 할당 가능

## 동시성 모델

시스템은 Tokio 비동기 런타임을 기반으로 하며:

- **태스크 기반 동시성**: 다양한 컴포넌트가 독립적인 태스크로 실행
- **채널 기반 통신**: mpsc(다중 생산자, 단일 소비자) 채널을 통한 컴포넌트 간 통신
- **락 최소화**: 경쟁 상태를 방지하기 위한 설계

## 확장성 고려사항

- **수평적 확장**: 심볼별 샤딩을 통해 여러 매칭 엔진 인스턴스 실행 가능
- **수직적 확장**: 고성능 하드웨어에서 더 많은 동시 연결 처리
- **분산 배포**: 주문 처리 파이프라인과 UI 업데이트 파이프라인을 별도 서버로 분리 가능

## 장애 복구 및 안정성

현재 구현에서는 기본적인 오류 처리만 제공하지만, 프로덕션 환경에서는 다음과 같은 기능이 필요합니다:

- **주문책 스냅샷**: 정기적인 상태 저장
- **지속성 계층**: 주문 및 체결 정보의 영구 저장
- **재연결 메커니즘**: 클라이언트 연결 끊김 시 복구
- **감시 시스템**: 시스템 상태 및 성능 모니터링
